import{getAddress as e}from"@ethersproject/address";import{BigNumber as r}from"@ethersproject/bignumber";import{hexDataSlice as t,arrayify as a,stripZeros as n,hexDataLength as s,splitSignature as o,hexConcat as i,hexlify as c,isBytesLike as u,hexZeroPad as m}from"@ethersproject/bytes";import{Zero as h}from"@ethersproject/constants";import{keccak256 as d}from"@ethersproject/keccak256";import{checkProperties as l}from"@ethersproject/properties";import*as p from"@ethersproject/rlp";import{computePublicKey as f,recoverPublicKey as g}from"@ethersproject/signing-key";import{Logger as y}from"@ethersproject/logger";const b="transactions/5.7.0";"use strict";const v=new y(b);var N;(function(e){e[e.legacy=0]="legacy";e[e.eip2930=1]="eip2930";e[e.eip1559=2]="eip1559"})(N||(N={}));function handleAddress(r){return"0x"===r?null:e(r)}function handleNumber(e){return"0x"===e?h:r.from(e)}const P=[{name:"nonce",maxLength:32,numeric:true},{name:"gasPrice",maxLength:32,numeric:true},{name:"gasLimit",maxLength:32,numeric:true},{name:"to",length:20},{name:"value",maxLength:32,numeric:true},{name:"data"}];const E={chainId:true,data:true,gasLimit:true,gasPrice:true,nonce:true,to:true,type:true,value:true};function computeAddress(r){const a=f(r);return e(t(d(t(a,1)),12))}function recoverAddress(e,r){return computeAddress(g(a(e),r))}function formatNumber(e,t){const a=n(r.from(e).toHexString());a.length>32&&v.throwArgumentError("invalid length for "+t,"transaction:"+t,e);return a}function accessSetify(r,t){return{address:e(r),storageKeys:(t||[]).map(((e,t)=>{32!==s(e)&&v.throwArgumentError("invalid access list storageKey",`accessList[${r}:${t}]`,e);return e.toLowerCase()}))}}function accessListify(e){if(Array.isArray(e))return e.map(((e,r)=>{if(Array.isArray(e)){e.length>2&&v.throwArgumentError("access list expected to be [ address, storageKeys[] ]",`value[${r}]`,e);return accessSetify(e[0],e[1])}return accessSetify(e.address,e.storageKeys)}));const r=Object.keys(e).map((r=>{const t=e[r].reduce(((e,r)=>{e[r]=true;return e}),{});return accessSetify(r,Object.keys(t).sort())}));r.sort(((e,r)=>e.address.localeCompare(r.address)));return r}function formatAccessList(e){return accessListify(e).map((e=>[e.address,e.storageKeys]))}function _serializeEip1559(t,a){if(null!=t.gasPrice){const e=r.from(t.gasPrice);const a=r.from(t.maxFeePerGas||0);e.eq(a)||v.throwArgumentError("mismatch EIP-1559 gasPrice != maxFeePerGas","tx",{gasPrice:e,maxFeePerGas:a})}const s=[formatNumber(t.chainId||0,"chainId"),formatNumber(t.nonce||0,"nonce"),formatNumber(t.maxPriorityFeePerGas||0,"maxPriorityFeePerGas"),formatNumber(t.maxFeePerGas||0,"maxFeePerGas"),formatNumber(t.gasLimit||0,"gasLimit"),null!=t.to?e(t.to):"0x",formatNumber(t.value||0,"value"),t.data||"0x",formatAccessList(t.accessList||[])];if(a){const e=o(a);s.push(formatNumber(e.recoveryParam,"recoveryParam"));s.push(n(e.r));s.push(n(e.s))}return i(["0x02",p.encode(s)])}function _serializeEip2930(r,t){const a=[formatNumber(r.chainId||0,"chainId"),formatNumber(r.nonce||0,"nonce"),formatNumber(r.gasPrice||0,"gasPrice"),formatNumber(r.gasLimit||0,"gasLimit"),null!=r.to?e(r.to):"0x",formatNumber(r.value||0,"value"),r.data||"0x",formatAccessList(r.accessList||[])];if(t){const e=o(t);a.push(formatNumber(e.recoveryParam,"recoveryParam"));a.push(n(e.r));a.push(n(e.s))}return i(["0x01",p.encode(a)])}function _serialize(e,r){l(e,E);const t=[];P.forEach((function(r){let s=e[r.name]||[];const o={};r.numeric&&(o.hexPad="left");s=a(c(s,o));r.length&&s.length!==r.length&&s.length>0&&v.throwArgumentError("invalid length for "+r.name,"transaction:"+r.name,s);if(r.maxLength){s=n(s);s.length>r.maxLength&&v.throwArgumentError("invalid length for "+r.name,"transaction:"+r.name,s)}t.push(c(s))}));let s=0;if(null!=e.chainId){s=e.chainId;"number"!==typeof s&&v.throwArgumentError("invalid transaction.chainId","transaction",e)}else r&&!u(r)&&r.v>28&&(s=Math.floor((r.v-35)/2));if(0!==s){t.push(c(s));t.push("0x");t.push("0x")}if(!r)return p.encode(t);const i=o(r);let m=27+i.recoveryParam;if(0!==s){t.pop();t.pop();t.pop();m+=2*s+8;i.v>28&&i.v!==m&&v.throwArgumentError("transaction.chainId/signature.v mismatch","signature",r)}else i.v!==m&&v.throwArgumentError("transaction.chainId/signature.v mismatch","signature",r);t.push(c(m));t.push(n(a(i.r)));t.push(n(a(i.s)));return p.encode(t)}function serialize(e,r){if(null==e.type||0===e.type){null!=e.accessList&&v.throwArgumentError("untyped transactions do not support accessList; include type: 1","transaction",e);return _serialize(e,r)}switch(e.type){case 1:return _serializeEip2930(e,r);case 2:return _serializeEip1559(e,r);default:break}return v.throwError(`unsupported transaction type: ${e.type}`,y.errors.UNSUPPORTED_OPERATION,{operation:"serializeTransaction",transactionType:e.type})}function _parseEipSignature(e,r,t){try{const t=handleNumber(r[0]).toNumber();if(0!==t&&1!==t)throw new Error("bad recid");e.v=t}catch(e){v.throwArgumentError("invalid v for transaction type: 1","v",r[0])}e.r=m(r[1],32);e.s=m(r[2],32);try{const r=d(t(e));e.from=recoverAddress(r,{r:e.r,s:e.s,recoveryParam:e.v})}catch(e){}}function _parseEip1559(e){const r=p.decode(e.slice(1));9!==r.length&&12!==r.length&&v.throwArgumentError("invalid component count for transaction type: 2","payload",c(e));const t=handleNumber(r[2]);const a=handleNumber(r[3]);const n={type:2,chainId:handleNumber(r[0]).toNumber(),nonce:handleNumber(r[1]).toNumber(),maxPriorityFeePerGas:t,maxFeePerGas:a,gasPrice:null,gasLimit:handleNumber(r[4]),to:handleAddress(r[5]),value:handleNumber(r[6]),data:r[7],accessList:accessListify(r[8])};if(9===r.length)return n;n.hash=d(e);_parseEipSignature(n,r.slice(9),_serializeEip1559);return n}function _parseEip2930(e){const r=p.decode(e.slice(1));8!==r.length&&11!==r.length&&v.throwArgumentError("invalid component count for transaction type: 1","payload",c(e));const t={type:1,chainId:handleNumber(r[0]).toNumber(),nonce:handleNumber(r[1]).toNumber(),gasPrice:handleNumber(r[2]),gasLimit:handleNumber(r[3]),to:handleAddress(r[4]),value:handleNumber(r[5]),data:r[6],accessList:accessListify(r[7])};if(8===r.length)return t;t.hash=d(e);_parseEipSignature(t,r.slice(8),_serializeEip2930);return t}function _parse(e){const t=p.decode(e);9!==t.length&&6!==t.length&&v.throwArgumentError("invalid raw transaction","rawTransaction",e);const a={nonce:handleNumber(t[0]).toNumber(),gasPrice:handleNumber(t[1]),gasLimit:handleNumber(t[2]),to:handleAddress(t[3]),value:handleNumber(t[4]),data:t[5],chainId:0};if(6===t.length)return a;try{a.v=r.from(t[6]).toNumber()}catch(e){return a}a.r=m(t[7],32);a.s=m(t[8],32);if(r.from(a.r).isZero()&&r.from(a.s).isZero()){a.chainId=a.v;a.v=0}else{a.chainId=Math.floor((a.v-35)/2);a.chainId<0&&(a.chainId=0);let r=a.v-27;const n=t.slice(0,6);if(0!==a.chainId){n.push(c(a.chainId));n.push("0x");n.push("0x");r-=2*a.chainId+8}const s=d(p.encode(n));try{a.from=recoverAddress(s,{r:c(a.r),s:c(a.s),recoveryParam:r})}catch(e){}a.hash=d(e)}a.type=null;return a}function parse(e){const r=a(e);if(r[0]>127)return _parse(r);switch(r[0]){case 1:return _parseEip2930(r);case 2:return _parseEip1559(r);default:break}return v.throwError(`unsupported transaction type: ${r[0]}`,y.errors.UNSUPPORTED_OPERATION,{operation:"parseTransaction",transactionType:r[0]})}export{N as TransactionTypes,accessListify,computeAddress,parse,recoverAddress,serialize};

