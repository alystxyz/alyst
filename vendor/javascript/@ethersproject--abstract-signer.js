import{defineReadOnly as e,resolveProperties as r,shallowCopy as t}from"@ethersproject/properties";import{Logger as i}from"@ethersproject/logger";const n="abstract-signer/5.7.0";"use strict";var s=(void 0,function(e,r,t,i){function adopt(e){return e instanceof t?e:new t((function(r){r(e)}))}return new(t||(t=Promise))((function(t,n){function fulfilled(e){try{step(i.next(e))}catch(e){n(e)}}function rejected(e){try{step(i.throw(e))}catch(e){n(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,r||[])).next())}))});const o=new i(n);const a=["accessList","ccipReadEnabled","chainId","customData","data","from","gasLimit","gasPrice","maxFeePerGas","maxPriorityFeePerGas","nonce","to","type","value"];const c=[i.errors.INSUFFICIENT_FUNDS,i.errors.NONCE_EXPIRED,i.errors.REPLACEMENT_UNDERPRICED];class Signer{constructor(){o.checkAbstract(new.target,Signer);e(this,"_isSigner",true)}getBalance(e){return s(this,void 0,void 0,(function*(){this._checkProvider("getBalance");return yield this.provider.getBalance(this.getAddress(),e)}))}getTransactionCount(e){return s(this,void 0,void 0,(function*(){this._checkProvider("getTransactionCount");return yield this.provider.getTransactionCount(this.getAddress(),e)}))}estimateGas(e){return s(this,void 0,void 0,(function*(){this._checkProvider("estimateGas");const t=yield r(this.checkTransaction(e));return yield this.provider.estimateGas(t)}))}call(e,t){return s(this,void 0,void 0,(function*(){this._checkProvider("call");const i=yield r(this.checkTransaction(e));return yield this.provider.call(i,t)}))}sendTransaction(e){return s(this,void 0,void 0,(function*(){this._checkProvider("sendTransaction");const r=yield this.populateTransaction(e);const t=yield this.signTransaction(r);return yield this.provider.sendTransaction(t)}))}getChainId(){return s(this,void 0,void 0,(function*(){this._checkProvider("getChainId");const e=yield this.provider.getNetwork();return e.chainId}))}getGasPrice(){return s(this,void 0,void 0,(function*(){this._checkProvider("getGasPrice");return yield this.provider.getGasPrice()}))}getFeeData(){return s(this,void 0,void 0,(function*(){this._checkProvider("getFeeData");return yield this.provider.getFeeData()}))}resolveName(e){return s(this,void 0,void 0,(function*(){this._checkProvider("resolveName");return yield this.provider.resolveName(e)}))}checkTransaction(e){for(const r in e)-1===a.indexOf(r)&&o.throwArgumentError("invalid transaction key: "+r,"transaction",e);const r=t(e);null==r.from?r.from=this.getAddress():r.from=Promise.all([Promise.resolve(r.from),this.getAddress()]).then((r=>{r[0].toLowerCase()!==r[1].toLowerCase()&&o.throwArgumentError("from address mismatch","transaction",e);return r[0]}));return r}populateTransaction(e){return s(this,void 0,void 0,(function*(){const t=yield r(this.checkTransaction(e));if(null!=t.to){t.to=Promise.resolve(t.to).then((e=>s(this,void 0,void 0,(function*(){if(null==e)return null;const r=yield this.resolveName(e);null==r&&o.throwArgumentError("provided ENS name resolves to null","tx.to",e);return r}))));t.to.catch((e=>{}))}const n=null!=t.maxFeePerGas||null!=t.maxPriorityFeePerGas;null==t.gasPrice||2!==t.type&&!n?0!==t.type&&1!==t.type||!n||o.throwArgumentError("pre-eip-1559 transaction do not support maxFeePerGas/maxPriorityFeePerGas","transaction",e):o.throwArgumentError("eip-1559 transaction do not support gasPrice","transaction",e);if(2!==t.type&&null!=t.type||null==t.maxFeePerGas||null==t.maxPriorityFeePerGas)if(0===t.type||1===t.type)null==t.gasPrice&&(t.gasPrice=this.getGasPrice());else{const e=yield this.getFeeData();if(null==t.type)if(null!=e.maxFeePerGas&&null!=e.maxPriorityFeePerGas){t.type=2;if(null!=t.gasPrice){const e=t.gasPrice;delete t.gasPrice;t.maxFeePerGas=e;t.maxPriorityFeePerGas=e}else{null==t.maxFeePerGas&&(t.maxFeePerGas=e.maxFeePerGas);null==t.maxPriorityFeePerGas&&(t.maxPriorityFeePerGas=e.maxPriorityFeePerGas)}}else if(null!=e.gasPrice){n&&o.throwError("network does not support EIP-1559",i.errors.UNSUPPORTED_OPERATION,{operation:"populateTransaction"});null==t.gasPrice&&(t.gasPrice=e.gasPrice);t.type=0}else o.throwError("failed to get consistent fee data",i.errors.UNSUPPORTED_OPERATION,{operation:"signer.getFeeData"});else if(2===t.type){null==t.maxFeePerGas&&(t.maxFeePerGas=e.maxFeePerGas);null==t.maxPriorityFeePerGas&&(t.maxPriorityFeePerGas=e.maxPriorityFeePerGas)}}else t.type=2;null==t.nonce&&(t.nonce=this.getTransactionCount("pending"));null==t.gasLimit&&(t.gasLimit=this.estimateGas(t).catch((e=>{if(c.indexOf(e.code)>=0)throw e;return o.throwError("cannot estimate gas; transaction may fail or may require manual gas limit",i.errors.UNPREDICTABLE_GAS_LIMIT,{error:e,tx:t})})));null==t.chainId?t.chainId=this.getChainId():t.chainId=Promise.all([Promise.resolve(t.chainId),this.getChainId()]).then((r=>{0!==r[1]&&r[0]!==r[1]&&o.throwArgumentError("chainId address mismatch","transaction",e);return r[0]}));return yield r(t)}))}_checkProvider(e){this.provider||o.throwError("missing provider",i.errors.UNSUPPORTED_OPERATION,{operation:e||"_checkProvider"})}static isSigner(e){return!!(e&&e._isSigner)}}class VoidSigner extends Signer{constructor(r,t){super();e(this,"address",r);e(this,"provider",t||null)}getAddress(){return Promise.resolve(this.address)}_fail(e,r){return Promise.resolve().then((()=>{o.throwError(e,i.errors.UNSUPPORTED_OPERATION,{operation:r})}))}signMessage(e){return this._fail("VoidSigner cannot sign messages","signMessage")}signTransaction(e){return this._fail("VoidSigner cannot sign transactions","signTransaction")}_signTypedData(e,r,t){return this._fail("VoidSigner cannot sign typed data","signTypedData")}connect(e){return new VoidSigner(this.address,e)}}export{Signer,VoidSigner};

