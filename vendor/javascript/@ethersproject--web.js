import{encode as e,decode as t}from"@ethersproject/base64";import{arrayify as r,isBytesLike as o,hexlify as n}from"@ethersproject/bytes";import{shallowCopy as s}from"@ethersproject/properties";import{toUtf8String as i,toUtf8Bytes as l}from"@ethersproject/strings";import{Logger as c}from"@ethersproject/logger";const u="web/5.7.1";"use strict";var a=(void 0,function(e,t,r,o){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,n){function fulfilled(e){try{step(o.next(e))}catch(e){n(e)}}function rejected(e){try{step(o.throw(e))}catch(e){n(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))});function getUrl(e,t){return a(this,void 0,void 0,(function*(){null==t&&(t={});const o={method:t.method||"GET",headers:t.headers||{},body:t.body||void 0};if(true!==t.skipFetchSetup){o.mode="cors";o.cache="no-cache";o.credentials="same-origin";o.redirect="follow";o.referrer="client"}if(null!=t.fetchOptions){const e=t.fetchOptions;e.mode&&(o.mode=e.mode);e.cache&&(o.cache=e.cache);e.credentials&&(o.credentials=e.credentials);e.redirect&&(o.redirect=e.redirect);e.referrer&&(o.referrer=e.referrer)}const n=yield fetch(e,o);const s=yield n.arrayBuffer();const i={};n.headers.forEach?n.headers.forEach(((e,t)=>{i[t.toLowerCase()]=e})):n.headers.keys().forEach((e=>{i[e.toLowerCase()]=n.headers.get(e)}));return{headers:i,statusCode:n.status,statusMessage:n.statusText,body:r(new Uint8Array(s))}}))}"use strict";var d=(void 0,function(e,t,r,o){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,n){function fulfilled(e){try{step(o.next(e))}catch(e){n(e)}}function rejected(e){try{step(o.throw(e))}catch(e){n(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))});const f=new c(u);function staller(e){return new Promise((t=>{setTimeout(t,e)}))}function bodyify(e,t){if(null==e)return null;if("string"===typeof e)return e;if(o(e)){if(t&&("text"===t.split("/")[0]||"application/json"===t.split(";")[0].trim()))try{return i(e)}catch(e){}return n(e)}return e}function unpercent(e){return l(e.replace(/%([0-9a-f][0-9a-f])/gi,((e,t)=>String.fromCharCode(parseInt(t,16)))))}function _fetchData(r,o,n){const i="object"===typeof r&&null!=r.throttleLimit?r.throttleLimit:12;f.assertArgument(i>0&&i%1===0,"invalid connection throttle limit","connection.throttleLimit",i);const u="object"===typeof r?r.throttleCallback:null;const a="object"===typeof r&&"number"===typeof r.throttleSlotInterval?r.throttleSlotInterval:100;f.assertArgument(a>0&&a%1===0,"invalid connection throttle slot interval","connection.throttleSlotInterval",a);const h="object"===typeof r&&!!r.errorPassThrough;const p={};let y=null;const m={method:"GET"};let b=false;let E=12e4;if("string"===typeof r)y=r;else if("object"===typeof r){null!=r&&null!=r.url||f.throwArgumentError("missing URL","connection.url",r);y=r.url;"number"===typeof r.timeout&&r.timeout>0&&(E=r.timeout);if(r.headers)for(const e in r.headers){p[e.toLowerCase()]={key:e,value:String(r.headers[e])};["if-none-match","if-modified-since"].indexOf(e.toLowerCase())>=0&&(b=true)}m.allowGzip=!!r.allowGzip;if(null!=r.user&&null!=r.password){"https:"!==y.substring(0,6)&&true!==r.allowInsecureAuthentication&&f.throwError("basic authentication requires a secure https url",c.errors.INVALID_ARGUMENT,{argument:"url",url:y,user:r.user,password:"[REDACTED]"});const t=r.user+":"+r.password;p.authorization={key:"Authorization",value:"Basic "+e(l(t))}}null!=r.skipFetchSetup&&(m.skipFetchSetup=!!r.skipFetchSetup);null!=r.fetchOptions&&(m.fetchOptions=s(r.fetchOptions))}const g=new RegExp("^data:([^;:]*)?(;base64)?,(.*)$","i");const w=y?y.match(g):null;if(w)try{const e={statusCode:200,statusMessage:"OK",headers:{"content-type":w[1]||"text/plain"},body:w[2]?t(w[3]):unpercent(w[3])};let r=e.body;n&&(r=n(e.body,e));return Promise.resolve(r)}catch(e){f.throwError("processing response error",c.errors.SERVER_ERROR,{body:bodyify(w[1],w[2]),error:e,requestBody:null,requestMethod:"GET",url:y})}if(o){m.method="POST";m.body=o;null==p["content-type"]&&(p["content-type"]={key:"Content-Type",value:"application/octet-stream"});null==p["content-length"]&&(p["content-length"]={key:"Content-Length",value:String(o.length)})}const R={};Object.keys(p).forEach((e=>{const t=p[e];R[t.key]=t.value}));m.headers=R;const v=function(){let e=null;const t=new Promise((function(t,r){E&&(e=setTimeout((()=>{if(null!=e){e=null;r(f.makeError("timeout",c.errors.TIMEOUT,{requestBody:bodyify(m.body,R["content-type"]),requestMethod:m.method,timeout:E,url:y}))}}),E))}));const cancel=function(){if(null!=e){clearTimeout(e);e=null}};return{promise:t,cancel:cancel}}();const k=function(){return d(this,void 0,void 0,(function*(){for(let e=0;e<i;e++){let t=null;try{t=yield getUrl(y,m);if(e<i)if(301===t.statusCode||302===t.statusCode){const e=t.headers.location||"";if("GET"===m.method&&e.match(/^https:/)){y=t.headers.location;continue}}else if(429===t.statusCode){let r=true;u&&(r=yield u(e,y));if(r){let r=0;const o=t.headers["retry-after"];r="string"===typeof o&&o.match(/^[1-9][0-9]*$/)?1e3*parseInt(o):a*parseInt(String(Math.random()*Math.pow(2,e)));yield staller(r);continue}}}catch(e){t=e.response;if(null==t){v.cancel();f.throwError("missing response",c.errors.SERVER_ERROR,{requestBody:bodyify(m.body,R["content-type"]),requestMethod:m.method,serverError:e,url:y})}}let r=t.body;if(b&&304===t.statusCode)r=null;else if(!h&&(t.statusCode<200||t.statusCode>=300)){v.cancel();f.throwError("bad response",c.errors.SERVER_ERROR,{status:t.statusCode,headers:t.headers,body:bodyify(r,t.headers?t.headers["content-type"]:null),requestBody:bodyify(m.body,R["content-type"]),requestMethod:m.method,url:y})}if(n)try{const e=yield n(r,t);v.cancel();return e}catch(o){if(o.throttleRetry&&e<i){let t=true;u&&(t=yield u(e,y));if(t){const t=a*parseInt(String(Math.random()*Math.pow(2,e)));yield staller(t);continue}}v.cancel();f.throwError("processing response error",c.errors.SERVER_ERROR,{body:bodyify(r,t.headers?t.headers["content-type"]:null),error:o,requestBody:bodyify(m.body,R["content-type"]),requestMethod:m.method,url:y})}v.cancel();return r}return f.throwError("failed response",c.errors.SERVER_ERROR,{requestBody:bodyify(m.body,R["content-type"]),requestMethod:m.method,url:y})}))}();return Promise.race([v.promise,k])}function fetchJson(e,t,r){let processJsonFunc=(e,t)=>{let o=null;if(null!=e)try{o=JSON.parse(i(e))}catch(t){f.throwError("invalid JSON",c.errors.SERVER_ERROR,{body:e,error:t})}r&&(o=r(o,t));return o};let o=null;if(null!=t){o=l(t);const r="string"===typeof e?{url:e}:s(e);if(r.headers){const e=0!==Object.keys(r.headers).filter((e=>"content-type"===e.toLowerCase())).length;if(!e){r.headers=s(r.headers);r.headers["content-type"]="application/json"}}else r.headers={"content-type":"application/json"};e=r}return _fetchData(e,o,processJsonFunc)}function poll(e,t){t||(t={});t=s(t);null==t.floor&&(t.floor=0);null==t.ceiling&&(t.ceiling=1e4);null==t.interval&&(t.interval=250);return new Promise((function(r,o){let n=null;let s=false;const cancel=()=>{if(s)return false;s=true;n&&clearTimeout(n);return true};t.timeout&&(n=setTimeout((()=>{cancel()&&o(new Error("timeout"))}),t.timeout));const i=t.retryLimit;let l=0;function check(){return e().then((function(e){if(void 0!==e)cancel()&&r(e);else if(t.oncePoll)t.oncePoll.once("poll",check);else if(t.onceBlock)t.onceBlock.once("block",check);else if(!s){l++;if(l>i){cancel()&&o(new Error("retry limit reached"));return}let e=t.interval*parseInt(String(Math.random()*Math.pow(2,l)));e<t.floor&&(e=t.floor);e>t.ceiling&&(e=t.ceiling);setTimeout(check,e)}return null}),(function(e){cancel()&&o(e)}))}check()}))}export{_fetchData,fetchJson,poll};

